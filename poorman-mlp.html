<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>穷人深度学习：MLP</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/default.min.css">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js"></script>
</head>

<body>
    <a href="index.html">Home</a> <!-- <a href="tags.html">Tags</a> -->
    <div class="document"><h1>穷人深度学习：MLP</h1><p>先来解释一下标题．穷人指的是我们的程序在 CPU 上跑，而且跑的是我们自己写的 C++ 程序，而不是在 GPU 上运行 PyTorch 之类的深度学习框架．MLP 是最简单、最容易实现的人工神经网络层，所以我们先从这开始．
</p><h2>计算图</h2><p>计算图指的是张量计算的依赖关系图．在前馈神经网络中，这张图会是一幅 DAG．我们会提出（抄）我们想要拟合的函数及拟合模型，然后我们就可以用 loss 函数来量化模型的拟合程度，并优化这个 loss 函数的值．
</p><h2>任务</h2><p>我们从最经典的 MNIST 开始．输入是转换为向量的 28*28 灰度图像，输出是一个数字．我们将使用 one-hot encoding 将这个数字转化成一个 10 维的向量，然后用 cross entropy 作为 loss 函数．这些函数的定义如下：
</p><figure><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="233.26pt" height="52.17pt" viewBox="0 0 233.26 52.17" version="1.2">
<defs>
<g>
<symbol overflow="visible" id="glyph0-0">
<path style="stroke:none;" d=""/>
</symbol>
<symbol overflow="visible" id="glyph0-1">
<path style="stroke:none;" d="M 3.453125 -3.125 C 3.515625 -3.390625 3.75 -4.34375 4.46875 -4.34375 C 4.53125 -4.34375 4.765625 -4.34375 4.984375 -4.203125 C 4.703125 -4.15625 4.5 -3.890625 4.5 -3.640625 C 4.5 -3.484375 4.609375 -3.28125 4.890625 -3.28125 C 5.109375 -3.28125 5.4375 -3.46875 5.4375 -3.890625 C 5.4375 -4.421875 4.828125 -4.5625 4.484375 -4.5625 C 3.890625 -4.5625 3.515625 -4.015625 3.390625 -3.78125 C 3.140625 -4.46875 2.578125 -4.5625 2.28125 -4.5625 C 1.203125 -4.5625 0.625 -3.234375 0.625 -2.96875 C 0.625 -2.875 0.71875 -2.875 0.75 -2.875 C 0.828125 -2.875 0.859375 -2.890625 0.875 -2.984375 C 1.234375 -4.078125 1.90625 -4.34375 2.265625 -4.34375 C 2.453125 -4.34375 2.8125 -4.25 2.8125 -3.640625 C 2.8125 -3.328125 2.640625 -2.640625 2.265625 -1.1875 C 2.09375 -0.546875 1.734375 -0.109375 1.28125 -0.109375 C 1.21875 -0.109375 0.984375 -0.109375 0.765625 -0.25 C 1.015625 -0.296875 1.25 -0.515625 1.25 -0.8125 C 1.25 -1.078125 1.015625 -1.171875 0.875 -1.171875 C 0.5625 -1.171875 0.296875 -0.90625 0.296875 -0.5625 C 0.296875 -0.09375 0.8125 0.109375 1.265625 0.109375 C 1.953125 0.109375 2.328125 -0.609375 2.359375 -0.671875 C 2.484375 -0.296875 2.84375 0.109375 3.46875 0.109375 C 4.53125 0.109375 5.125 -1.21875 5.125 -1.484375 C 5.125 -1.578125 5.03125 -1.578125 5 -1.578125 C 4.90625 -1.578125 4.890625 -1.53125 4.859375 -1.46875 C 4.53125 -0.359375 3.828125 -0.109375 3.484375 -0.109375 C 3.09375 -0.109375 2.921875 -0.4375 2.921875 -0.796875 C 2.921875 -1.015625 2.984375 -1.25 3.09375 -1.703125 Z M 3.453125 -3.125 "/>
</symbol>
<symbol overflow="visible" id="glyph0-2">
<path style="stroke:none;" d="M 5.015625 -3.9375 C 5.0625 -4.078125 5.0625 -4.09375 5.0625 -4.171875 C 5.0625 -4.359375 4.921875 -4.453125 4.765625 -4.453125 C 4.65625 -4.453125 4.5 -4.390625 4.40625 -4.234375 C 4.375 -4.1875 4.296875 -3.859375 4.25 -3.671875 C 4.1875 -3.40625 4.109375 -3.125 4.046875 -2.84375 L 3.578125 -0.984375 C 3.546875 -0.84375 3.09375 -0.109375 2.421875 -0.109375 C 1.890625 -0.109375 1.78125 -0.5625 1.78125 -0.953125 C 1.78125 -1.421875 1.953125 -2.0625 2.296875 -2.96875 C 2.46875 -3.390625 2.515625 -3.515625 2.515625 -3.71875 C 2.515625 -4.1875 2.171875 -4.5625 1.65625 -4.5625 C 0.6875 -4.5625 0.296875 -3.0625 0.296875 -2.96875 C 0.296875 -2.875 0.40625 -2.875 0.421875 -2.875 C 0.53125 -2.875 0.53125 -2.890625 0.59375 -3.0625 C 0.875 -4.03125 1.28125 -4.34375 1.625 -4.34375 C 1.71875 -4.34375 1.890625 -4.34375 1.890625 -4 C 1.890625 -3.75 1.78125 -3.484375 1.71875 -3.28125 C 1.296875 -2.1875 1.109375 -1.59375 1.109375 -1.109375 C 1.109375 -0.203125 1.765625 0.109375 2.375 0.109375 C 2.78125 0.109375 3.125 -0.0625 3.421875 -0.34375 C 3.28125 0.1875 3.15625 0.6875 2.75 1.234375 C 2.484375 1.59375 2.09375 1.890625 1.609375 1.890625 C 1.46875 1.890625 1 1.859375 0.828125 1.453125 C 0.984375 1.453125 1.125 1.453125 1.265625 1.328125 C 1.375 1.234375 1.484375 1.109375 1.484375 0.90625 C 1.484375 0.59375 1.203125 0.546875 1.09375 0.546875 C 0.859375 0.546875 0.515625 0.71875 0.515625 1.21875 C 0.515625 1.734375 0.96875 2.125 1.609375 2.125 C 2.671875 2.125 3.734375 1.171875 4.03125 0.015625 Z M 5.015625 -3.9375 "/>
</symbol>
<symbol overflow="visible" id="glyph0-3">
<path style="stroke:none;" d="M 3.859375 -6.25 C 3.953125 -6.625 3.984375 -6.734375 4.953125 -6.734375 C 5.265625 -6.734375 5.34375 -6.734375 5.34375 -6.9375 C 5.34375 -7.046875 5.234375 -7.046875 5.1875 -7.046875 C 4.84375 -7.046875 4 -7.015625 3.65625 -7.015625 C 3.34375 -7.015625 2.59375 -7.046875 2.28125 -7.046875 C 2.203125 -7.046875 2.09375 -7.046875 2.09375 -6.84375 C 2.09375 -6.734375 2.171875 -6.734375 2.375 -6.734375 C 2.390625 -6.734375 2.59375 -6.734375 2.765625 -6.71875 C 2.953125 -6.6875 3.046875 -6.6875 3.046875 -6.546875 C 3.046875 -6.5 3.03125 -6.46875 3 -6.359375 L 1.625 -0.8125 C 1.515625 -0.40625 1.5 -0.3125 0.6875 -0.3125 C 0.5 -0.3125 0.40625 -0.3125 0.40625 -0.109375 C 0.40625 0 0.5 0 0.6875 0 L 5.46875 0 C 5.71875 0 5.71875 0 5.78125 -0.171875 L 6.59375 -2.40625 C 6.640625 -2.515625 6.640625 -2.546875 6.640625 -2.546875 C 6.640625 -2.59375 6.609375 -2.671875 6.515625 -2.671875 C 6.421875 -2.671875 6.40625 -2.609375 6.34375 -2.453125 C 5.984375 -1.5 5.53125 -0.3125 3.75 -0.3125 L 2.78125 -0.3125 C 2.640625 -0.3125 2.609375 -0.3125 2.546875 -0.328125 C 2.453125 -0.34375 2.421875 -0.34375 2.421875 -0.4375 C 2.421875 -0.46875 2.421875 -0.484375 2.46875 -0.671875 Z M 3.859375 -6.25 "/>
</symbol>
<symbol overflow="visible" id="glyph1-0">
<path style="stroke:none;" d=""/>
</symbol>
<symbol overflow="visible" id="glyph1-1">
<path style="stroke:none;" d="M 2.296875 -4.359375 C 2.296875 -4.546875 2.28125 -4.546875 2.09375 -4.546875 C 1.65625 -4.125 1.03125 -4.109375 0.75 -4.109375 L 0.75 -3.875 C 0.90625 -3.875 1.359375 -3.875 1.75 -4.0625 L 1.75 -0.5625 C 1.75 -0.34375 1.75 -0.25 1.0625 -0.25 L 0.796875 -0.25 L 0.796875 0 C 0.921875 0 1.765625 -0.03125 2.015625 -0.03125 C 2.234375 -0.03125 3.09375 0 3.25 0 L 3.25 -0.25 L 2.984375 -0.25 C 2.296875 -0.25 2.296875 -0.34375 2.296875 -0.5625 Z M 2.296875 -4.359375 "/>
</symbol>
<symbol overflow="visible" id="glyph1-2">
<path style="stroke:none;" d="M 3.46875 -1.25 L 3.234375 -1.25 C 3.203125 -1.09375 3.140625 -0.6875 3.046875 -0.625 C 3 -0.578125 2.46875 -0.578125 2.375 -0.578125 L 1.109375 -0.578125 C 1.828125 -1.21875 2.078125 -1.40625 2.484375 -1.734375 C 2.984375 -2.140625 3.46875 -2.5625 3.46875 -3.21875 C 3.46875 -4.046875 2.734375 -4.546875 1.859375 -4.546875 C 1.015625 -4.546875 0.4375 -3.953125 0.4375 -3.328125 C 0.4375 -2.984375 0.734375 -2.9375 0.796875 -2.9375 C 0.953125 -2.9375 1.15625 -3.0625 1.15625 -3.3125 C 1.15625 -3.421875 1.109375 -3.671875 0.75 -3.671875 C 0.96875 -4.15625 1.4375 -4.3125 1.75 -4.3125 C 2.4375 -4.3125 2.796875 -3.765625 2.796875 -3.21875 C 2.796875 -2.625 2.375 -2.140625 2.15625 -1.90625 L 0.5 -0.265625 C 0.4375 -0.203125 0.4375 -0.1875 0.4375 0 L 3.265625 0 Z M 3.46875 -1.25 "/>
</symbol>
<symbol overflow="visible" id="glyph2-0">
<path style="stroke:none;" d=""/>
</symbol>
<symbol overflow="visible" id="glyph2-1">
<path style="stroke:none;" d="M 1.984375 -2.578125 C 1.984375 -2.875 1.734375 -3.125 1.4375 -3.125 C 1.140625 -3.125 0.890625 -2.875 0.890625 -2.578125 C 0.890625 -2.28125 1.140625 -2.03125 1.4375 -2.03125 C 1.734375 -2.03125 1.984375 -2.28125 1.984375 -2.578125 Z M 1.984375 -2.578125 "/>
</symbol>
<symbol overflow="visible" id="glyph3-0">
<path style="stroke:none;" d=""/>
</symbol>
<symbol overflow="visible" id="glyph3-1">
<path style="stroke:none;" d="M 1.984375 -3.234375 C 2.046875 -3.359375 2.046875 -3.40625 2.046875 -3.453125 C 2.046875 -3.671875 1.859375 -3.828125 1.640625 -3.828125 C 1.390625 -3.828125 1.296875 -3.625 1.265625 -3.515625 L 0.359375 -0.546875 C 0.359375 -0.53125 0.328125 -0.4375 0.328125 -0.4375 C 0.328125 -0.34375 0.546875 -0.28125 0.59375 -0.28125 C 0.640625 -0.28125 0.65625 -0.296875 0.703125 -0.390625 Z M 1.984375 -3.234375 "/>
</symbol>
<symbol overflow="visible" id="glyph3-2">
<path style="stroke:none;" d="M 3.484375 -1.71875 C 3.484375 -2.546875 2.8125 -3.1875 2 -3.1875 C 1.1875 -3.1875 0.53125 -2.53125 0.53125 -1.71875 C 0.53125 -0.890625 1.1875 -0.25 2 -0.25 C 2.828125 -0.25 3.484375 -0.90625 3.484375 -1.71875 Z M 2 -0.578125 C 1.359375 -0.578125 0.859375 -1.109375 0.859375 -1.71875 C 0.859375 -2.359375 1.375 -2.859375 2 -2.859375 C 2.640625 -2.859375 3.140625 -2.328125 3.140625 -1.71875 C 3.140625 -1.078125 2.640625 -0.578125 2 -0.578125 Z M 2 -0.578125 "/>
</symbol>
<symbol overflow="visible" id="glyph4-0">
<path style="stroke:none;" d=""/>
</symbol>
<symbol overflow="visible" id="glyph4-1">
<path style="stroke:none;" d="M 3.75 -0.96875 C 4.390625 -1.625 4.640625 -2.53125 4.640625 -2.609375 C 4.640625 -2.703125 4.546875 -2.703125 4.515625 -2.703125 C 4.421875 -2.703125 4.421875 -2.671875 4.375 -2.53125 C 4.25 -2.078125 4.03125 -1.65625 3.734375 -1.28125 C 3.734375 -1.390625 3.71875 -1.84375 3.703125 -1.90625 C 3.59375 -2.59375 3.09375 -3.03125 2.40625 -3.03125 C 1.390625 -3.03125 0.421875 -2.078125 0.421875 -1.125 C 0.421875 -0.5 0.890625 0.0625 1.6875 0.0625 C 2.3125 0.0625 2.875 -0.21875 3.265625 -0.515625 C 3.421875 -0.015625 3.765625 0.0625 3.984375 0.0625 C 4.375 0.0625 4.625 -0.265625 4.625 -0.40625 C 4.625 -0.5 4.546875 -0.5 4.5 -0.5 C 4.421875 -0.5 4.40625 -0.46875 4.390625 -0.421875 C 4.296875 -0.171875 4.078125 -0.125 4 -0.125 C 3.90625 -0.125 3.78125 -0.125 3.75 -0.96875 Z M 3.21875 -0.734375 C 2.546875 -0.1875 1.96875 -0.125 1.703125 -0.125 C 1.25 -0.125 1 -0.421875 1 -0.890625 C 1 -1.078125 1.09375 -1.828125 1.453125 -2.3125 C 1.765625 -2.71875 2.15625 -2.828125 2.390625 -2.828125 C 2.9375 -2.828125 3.09375 -2.3125 3.15625 -1.875 C 3.203125 -1.578125 3.1875 -1.09375 3.21875 -0.734375 Z M 3.21875 -0.734375 "/>
</symbol>
<symbol overflow="visible" id="glyph4-2">
<path style="stroke:none;" d="M 2.828125 -4.125 C 2.890625 -4.375 2.90625 -4.4375 3.546875 -4.4375 C 3.75 -4.4375 3.828125 -4.4375 3.828125 -4.59375 C 3.828125 -4.59375 3.8125 -4.6875 3.703125 -4.6875 C 3.546875 -4.6875 3.359375 -4.671875 3.203125 -4.671875 C 3.03125 -4.65625 2.8125 -4.65625 2.640625 -4.65625 C 2.5 -4.65625 2.3125 -4.671875 2.171875 -4.671875 C 2.03125 -4.671875 1.859375 -4.6875 1.734375 -4.6875 C 1.6875 -4.6875 1.578125 -4.6875 1.578125 -4.53125 C 1.578125 -4.4375 1.671875 -4.4375 1.796875 -4.4375 C 1.8125 -4.4375 1.9375 -4.4375 2.0625 -4.421875 C 2.203125 -4.40625 2.21875 -4.390625 2.21875 -4.328125 C 2.21875 -4.3125 2.21875 -4.28125 2.1875 -4.171875 L 1.28125 -0.53125 C 1.21875 -0.296875 1.203125 -0.25 0.671875 -0.25 C 0.5625 -0.25 0.46875 -0.25 0.46875 -0.109375 C 0.46875 0 0.5625 0 0.671875 0 L 4.125 0 C 4.296875 0 4.3125 0 4.359375 -0.140625 C 4.4375 -0.328125 4.953125 -1.65625 4.953125 -1.703125 C 4.953125 -1.734375 4.9375 -1.796875 4.828125 -1.796875 C 4.75 -1.796875 4.734375 -1.765625 4.6875 -1.65625 C 4.4375 -1.015625 4.125 -0.25 2.875 -0.25 L 2.09375 -0.25 C 1.890625 -0.25 1.875 -0.25 1.875 -0.3125 C 1.875 -0.328125 1.875 -0.359375 1.90625 -0.453125 Z M 2.828125 -4.125 "/>
</symbol>
<symbol overflow="visible" id="glyph5-0">
<path style="stroke:none;" d=""/>
</symbol>
<symbol overflow="visible" id="glyph5-1">
<path style="stroke:none;" d="M 1.953125 -3.125 C 1.953125 -3.265625 1.9375 -3.265625 1.78125 -3.265625 C 1.421875 -2.953125 0.890625 -2.953125 0.78125 -2.953125 L 0.703125 -2.953125 L 0.703125 -2.734375 L 0.78125 -2.734375 C 0.890625 -2.734375 1.21875 -2.75 1.5 -2.875 L 1.5 -0.421875 C 1.5 -0.265625 1.5 -0.21875 0.984375 -0.21875 L 0.734375 -0.21875 L 0.734375 0 C 1 -0.015625 1.4375 -0.015625 1.734375 -0.015625 C 2.015625 -0.015625 2.453125 -0.015625 2.71875 0 L 2.71875 -0.21875 L 2.46875 -0.21875 C 1.953125 -0.21875 1.953125 -0.265625 1.953125 -0.421875 Z M 1.953125 -3.125 "/>
</symbol>
<symbol overflow="visible" id="glyph5-2">
<path style="stroke:none;" d="M 2.890625 -0.953125 L 2.6875 -0.953125 C 2.671875 -0.859375 2.625 -0.546875 2.546875 -0.5 C 2.5 -0.46875 2.09375 -0.46875 2.015625 -0.46875 L 1.0625 -0.46875 C 1.375 -0.71875 1.734375 -0.984375 2.03125 -1.1875 C 2.484375 -1.484375 2.890625 -1.765625 2.890625 -2.296875 C 2.890625 -2.921875 2.296875 -3.265625 1.59375 -3.265625 C 0.9375 -3.265625 0.453125 -2.890625 0.453125 -2.40625 C 0.453125 -2.15625 0.65625 -2.109375 0.734375 -2.109375 C 0.859375 -2.109375 1.015625 -2.1875 1.015625 -2.390625 C 1.015625 -2.578125 0.890625 -2.671875 0.734375 -2.6875 C 0.875 -2.90625 1.15625 -3.046875 1.484375 -3.046875 C 1.96875 -3.046875 2.359375 -2.765625 2.359375 -2.28125 C 2.359375 -1.875 2.078125 -1.5625 1.703125 -1.234375 L 0.5 -0.21875 C 0.453125 -0.1875 0.453125 -0.1875 0.453125 -0.140625 L 0.453125 0 L 2.734375 0 Z M 2.890625 -0.953125 "/>
</symbol>
</g>
</defs>
<g id="surface1">
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph0-1" x="5.915387" y="12.920442"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph0-2" x="45.536917" y="12.920442"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph1-1" x="50.604258" y="14.470757"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph0-2" x="88.718135" y="12.920442"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph1-2" x="93.785476" y="14.470757"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph2-1" x="131.899342" y="12.920442"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph2-1" x="136.477995" y="12.920442"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph2-1" x="141.066983" y="12.920442"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph0-2" x="177.671932" y="12.920442"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph3-1" x="183.110103" y="9.169754"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph0-3" x="219.575929" y="12.920442"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph0-2" x="179.047615" y="45.557088"/>
</g>
<path style="fill:none;stroke-width:0.41998;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -101.3791 16.381803 L -76.997271 16.381803 " transform="matrix(0.98434,0,0,-0.98434,116.264121,26.461195)"/>
<path style="fill:none;stroke-width:0.41998;stroke-linecap:round;stroke-linejoin:round;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -2.182964 2.520134 C -1.786124 1.008175 -0.897204 0.293864 -0.000346013 0.000202628 C -0.897204 -0.293459 -1.786124 -1.00777 -2.182964 -2.519729 " transform="matrix(0.98434,0,0,-0.98434,40.680028,10.336137)"/>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph4-1" x="17.60443" y="6.921414"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph5-1" x="22.70266" y="7.902072"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph3-2" x="26.530018" y="6.921414"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph4-2" x="30.548033" y="6.921414"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph5-1" x="35.928089" y="7.902072"/>
</g>
<path style="fill:none;stroke-width:0.41998;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -57.508475 16.381803 L -33.126647 16.381803 " transform="matrix(0.98434,0,0,-0.98434,116.264121,26.461195)"/>
<path style="fill:none;stroke-width:0.41998;stroke-linecap:round;stroke-linejoin:round;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -2.185078 2.520134 C -1.78427 1.008175 -0.895349 0.293864 0.00150827 0.000202628 C -0.895349 -0.293459 -1.78427 -1.00777 -2.185078 -2.519729 " transform="matrix(0.98434,0,0,-0.98434,83.861797,10.336137)"/>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph4-1" x="60.786198" y="6.921414"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph5-2" x="65.884428" y="7.902072"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph3-2" x="69.711787" y="6.921414"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph4-2" x="73.729802" y="6.921414"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph5-2" x="79.109858" y="7.902072"/>
</g>
<path style="fill:none;stroke-width:0.41998;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -13.64182 16.381803 L 10.740009 16.381803 " transform="matrix(0.98434,0,0,-0.98434,116.264121,26.461195)"/>
<path style="fill:none;stroke-width:0.41998;stroke-linecap:round;stroke-linejoin:round;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -2.183214 2.520134 C -1.786374 1.008175 -0.897453 0.293864 -0.000595847 0.000202628 C -0.897453 -0.293459 -1.786374 -1.00777 -2.183214 -2.519729 " transform="matrix(0.98434,0,0,-0.98434,127.043555,10.336137)"/>
<path style="fill:none;stroke-width:0.41998;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 32.859852 16.381803 L 57.24168 16.381803 " transform="matrix(0.98434,0,0,-0.98434,116.264121,26.461195)"/>
<path style="fill:none;stroke-width:0.41998;stroke-linecap:round;stroke-linejoin:round;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -2.182943 2.520134 C -1.786103 1.008175 -0.897182 0.293864 -0.000324628 0.000202628 C -0.897182 -0.293459 -1.786103 -1.00777 -2.182943 -2.519729 " transform="matrix(0.98434,0,0,-0.98434,172.816726,10.336137)"/>
<path style="fill:none;stroke-width:0.41998;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 75.43281 16.381803 L 99.814639 16.381803 " transform="matrix(0.98434,0,0,-0.98434,116.264121,26.461195)"/>
<path style="fill:none;stroke-width:0.41998;stroke-linecap:round;stroke-linejoin:round;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -2.185153 2.520134 C -1.784344 1.008175 -0.895424 0.293864 0.00143397 0.000202628 C -0.895424 -0.293459 -1.784344 -1.00777 -2.185153 -2.519729 " transform="matrix(0.98434,0,0,-0.98434,214.721245,10.336137)"/>
<path style="fill:none;stroke-width:0.41998;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 74.035935 -10.86124 L 99.905912 9.568066 " transform="matrix(0.98434,0,0,-0.98434,116.264121,26.461195)"/>
<path style="fill:none;stroke-width:0.41998;stroke-linecap:round;stroke-linejoin:round;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -2.183375 2.518129 C -1.782834 1.00833 -0.896386 0.293053 -0.00018336 -0.0000810286 C -0.895188 -0.294508 -1.786339 -1.006654 -2.182218 -2.519578 " transform="matrix(0.772441,-0.610064,-0.610064,-0.772441,214.765717,16.913888)"/>
</g>
</svg>
</figure><p><span class="math display">L=-\sum_iy_i\log y'_i</span>
</p><p>其中 <span class="math inline">\alpha_i</span> 是层激活函数，这里我们用 ReLU 函数，它的定义是 <span class="math inline">R(x)=\max(x,0)</span>；<span class="math inline">L_i</span> 是层传递函数，是左乘一个合适大小的矩阵再加合适大小的 bias．
</p><p><a href="http://yann.lecun.com/exdb/mnist/">MNIST</a> 数据集的网站上记录了各种方案训练后的成绩，我们这里实现一个 500+150 HU 的三层神经网络．
</p><h2>优化</h2><p>计算上优化函数取值的方法有很多种，但计算图的结构让我们能够简易地获得输出对每个参数的偏导．最简单的想法是每次让参数向量向偏导向量的反方向走一点，同时偏导可以对多组训练数据取平均值，这就是 SGD 算法．我实现了 <a href="https://arxiv.org/pdf/1412.6980.pdf">Adam</a> 算法，至少对这个任务来说比 SGD 收敛快得多．
</p><h2>实现</h2><p>我定义了一个 <code>tensor_t</code> 结构体用于存放张量的形状和数据，然后定义了若干节点，从公式中可以看出我们需要的结点大致是：
</p><ul><li><p>矩阵乘法
</p></li><li><p>张量加法
</p></li><li><p>log
</p></li><li><p>ReLU
</p></li><li><p>转置
</p></li><li><p>标量乘法
</p></li></ul><p>可以实现一个具有 <code>out</code>, <code>acc</code>, <code>calculate()</code>, <code>differentiate()</code> 的基类，然后让结点类型继承这个类．之后，可以将代码中的 <code>for</code> 循环改写成 <code>std::transform</code>，使用 <code>execution_policy</code> 可以做到一部分的并行化．当然，最终并行化还是需要在多个核心上复制计算图并计算不同的训练数据的梯度，再汇总．
</p><p>实例代码在 <a href="https://github.com/lrw04/tdle">仓库</a> 里，有很多重复代码．
</p></div>
    <script defer="" src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var mathElements = document.getElementsByClassName("math");
            var macros = {"\\Gal":"\\operatorname{Gal}","\\tr":"\\operatorname{tr}","\\GL":"\\operatorname{GL}","\\SL":"\\operatorname{SL}","\\PSL":"\\operatorname{PSL}","\\SO":"\\operatorname{SO}","\\SU":"\\operatorname{SU}","\\im":"\\operatorname{im}","\\cof":"\\operatorname{cof}","\\End":"\\operatorname{End}","\\Tor":"\\operatorname{Tor}","\\rk":"\\operatorname{rk}","\\Hom":"\\operatorname{Hom}","\\diag":"\\operatorname{diag}","\\vspan":"\\operatorname{span}","\\lcm":"\\operatorname{lcm}","\\id":"\\operatorname{id}","\\Ab":"\\textsf{Ab}","\\Fld":"\\textsf{Fld}","\\Mod":"#1\\textsf{-Mod}","\\Grp":"\\textsf{Grp}","\\dSet":"#1\\textsf{-Set}","\\Set":"\\textsf{Set}","\\SetStar":"\\textsf{Set*}","\\Vect":"#1\\textsf{-Vect}","\\Alg":"#1\\textsf{-Alg}","\\Ring":"\\textsf{Ring}","\\R":"\\mathbb{R}","\\C":"\\mathbb{C}","\\N":"\\mathbb{N}","\\Z":"\\mathbb{Z}","\\Q":"\\mathbb{Q}","\\F":"\\mathbb{F}","\\sfC":"\\mathsf{C}","\\vphi":"\\varphi"};
            for (var i = 0; i < mathElements.length; i++) {
                var texText = mathElements[i].firstChild;
                if (mathElements[i].tagName == "SPAN") {
                    katex.render(texText.data, mathElements[i], {
                        displayMode: mathElements[i].classList.contains('display'),
                        throwOnError: false,
                        macros: macros,
                        fleqn: false
                    });
                }
            }
            hljs.highlightAll();
        });
    </script>
</body>

</html>